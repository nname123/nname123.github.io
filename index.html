<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Color Sort Puzzle - Custom Level with Animation</title>
<style>
  body { font-family: sans-serif; background: #eef2f5; text-align: center; margin: 0; padding: 0; }
  h2 { margin: 10px 0; }
  p { margin: 5px 0; }
  .controls { margin: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
  button { padding: 10px 16px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  button:hover { opacity: 0.9; }
  button:active { transform: scale(0.96); }
  .btn-undo { background-color: #3498db; color: white; }
  .btn-redo { background-color: #2ecc71; color: white; }
  .btn-reset { background-color: #e74c3c; color: white; }
  .steps { font-size: 18px; margin-top: 8px; }
  .tube-rows { display: flex; flex-direction: column; align-items: center; gap: 20px; margin: 10px; }
  .tube-container { display: grid; grid-template-columns: repeat(7, 1fr); grid-gap: 10px; justify-content: center; }
  .tube { width: 60px; height: 180px; border: 2px solid #888; border-radius: 10px; display: flex; flex-direction: column-reverse; justify-content: flex-start; align-items: center; padding: 2px; background: white; margin: auto; }
  .ball { width: 40px; height: 40px; border-radius: 50%; margin: 2px 0; cursor: pointer; transition: transform 0.2s, background 0.2s; }
  .win { animation: flash 0.5s infinite; }
  @keyframes flash {
    0% { background: #2ecc71; transform: scale(1); }
    50% { background: #f1c40f; transform: scale(1.2); }
    100% { background: #2ecc71; transform: scale(1); }
  }
  @media (max-width: 600px) {
    .tube { width: 50px; height: 140px; }
    .ball { width: 30px; height: 30px; }
    button { font-size: 14px; padding: 8px 12px; }
  }
</style>
</head>
<body>
<h2>Color Sort Puzzle - Custom Level</h2>
<p>點選一個管子，再點另一個管子移動球。必須顏色相同或空管才能移動。</p>
<div class="controls">
  <button class="btn-undo" onclick="undo()">上一步</button>
  <button class="btn-redo" onclick="redo()">下一步</button>
  <button class="btn-reset" onclick="reset()">重設關卡</button>
</div>
<div class="steps">步數: <span id="steps">0</span></div>
<div class="tube-rows">
  <div class="tube-container" id="row1"></div>
  <div class="tube-container" id="row2"></div>
</div>

<script>
const colors = {
  red: '#e74c3c', blue: '#3498db', green: '#2ecc71', yellow: '#f1c40f',
  purple: '#9b59b6', orange: '#e67e22', pink: '#ff69b4', black: '#2d3436',
  cyan: '#00ffff', lime: '#a4de02', brown: '#8e5a2a', gray: '#95a5a6'
};

let initialLevel = [
  [], [],
  ['gray','red','pink','cyan'],
  ['cyan','gray','blue','pink'],
  ['brown','lime','purple','purple'],
  ['black','lime','green','red'],
  ['black','green','blue','green'],
  ['orange','green','purple','lime'],
  ['orange','purple','yellow','black'],
  ['brown','brown','pink','black'],
  ['blue','red','lime','red'],
  ['cyan','yellow','pink','orange'],
  ['orange','brown','yellow','gray'],
  ['blue','yellow','gray','cyan']
];

let level = [];
let history = [];
let redoStack = [];
let steps = 0;

const row1 = document.getElementById('row1');
const row2 = document.getElementById('row2');
const stepsEl = document.getElementById('steps');

function saveProgress() {
  localStorage.setItem('colorSortCustom', JSON.stringify(level));
  localStorage.setItem('colorSortHistoryCustom', JSON.stringify(history));
  localStorage.setItem('colorSortRedoCustom', JSON.stringify(redoStack));
  localStorage.setItem('colorSortStepsCustom', steps);
}

function loadProgress() {
  const savedLevel = localStorage.getItem('colorSortCustom');
  if (savedLevel) {
    level = JSON.parse(savedLevel);
    history = JSON.parse(localStorage.getItem('colorSortHistoryCustom')) || [];
    redoStack = JSON.parse(localStorage.getItem('colorSortRedoCustom')) || [];
    steps = parseInt(localStorage.getItem('colorSortStepsCustom')) || 0;
  } else {
    level = JSON.parse(JSON.stringify(initialLevel));
    history = [];
    redoStack = [];
    steps = 0;
  }
}

function render() {
  row1.innerHTML = '';
  row2.innerHTML = '';
  level.forEach((tube, i) => {
    const tubeEl = document.createElement('div');
    tubeEl.className = 'tube';
    tubeEl.dataset.index = i;
    tube.forEach(color => {
      const ball = document.createElement('div');
      ball.className = 'ball';
      ball.style.background = colors[color] || color;
      ball.dataset.color = color;
      tubeEl.appendChild(ball);
    });
    if (i < 7) row1.appendChild(tubeEl);
    else row2.appendChild(tubeEl);
  });
  stepsEl.textContent = steps;
  saveProgress();
}

let selected = null;

document.body.addEventListener('click', e => {
  const tubeEl = e.target.closest('.tube');
  if (!tubeEl) return;
  const idx = parseInt(tubeEl.dataset.index);

  if (selected === null) {
    if (level[idx].length > 0) {
      selected = idx;
      tubeEl.style.border = '3px solid red';
    }
  } else {
    if (selected !== idx) {
      let fromTube = level[selected];
      let toTube = level[idx];
      if (fromTube.length > 0 && toTube.length < 4) {
        let movingColor = fromTube[fromTube.length - 1];
        // 計算要移動幾個同色球
        let count = 1;
        for (let i = fromTube.length - 2; i >= 0; i--) {
          if (fromTube[i] === movingColor) count++;
          else break;
        }
        // 計算目標管能容納的數量
        let capacity = 4 - toTube.length;
        let moveCount = Math.min(count, capacity);
        if (toTube.length === 0 || toTube[toTube.length - 1] === movingColor) {
          history.push(JSON.parse(JSON.stringify(level)));
          redoStack = [];
          for (let i = 0; i < moveCount; i++) {
            toTube.push(fromTube.pop());
          }
          steps++;
        }
      }
    }
    document.querySelectorAll('.tube').forEach(t => t.style.border = '2px solid #888');
    selected = null;
    render();
    checkWin();
  }
});

function undo() {
  if (history.length > 0) {
    redoStack.push(JSON.parse(JSON.stringify(level)));
    level = history.pop();
    steps--;
    render();
  }
}

function redo() {
  if (redoStack.length > 0) {
    history.push(JSON.parse(JSON.stringify(level)));
    level = redoStack.pop();
    steps++;
    render();
  }
}

function reset() {
  level = JSON.parse(JSON.stringify(initialLevel));
  history = [];
  redoStack = [];
  steps = 0;
  render();
}

function checkWin() {
  let done = level.every(tube => tube.length === 0 || tube.every(c => c === tube[0]));
  if (done) {
    document.querySelectorAll('.ball').forEach(ball => ball.classList.add('win'));
    alert('You Win! 總步數: ' + steps);
  }
}

loadProgress();
render();
</script>
</body>
</html>