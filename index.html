<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Color Sort Puzzle - Enhanced</title>
<style>
  body { font-family: sans-serif; background: #eef2f5; text-align: center; margin: 0; padding: 0; }
  h2 { margin: 10px 0; }
  p { margin: 5px 0; }
  .controls { margin: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
  button { padding: 10px 16px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  button:hover { opacity: 0.9; }
  button:active { transform: scale(0.96); }
  .btn-undo { background-color: #3498db; color: white; }
  .btn-redo { background-color: #2ecc71; color: white; }
  .btn-reset { background-color: #e74c3c; color: white; }
  .steps { font-size: 18px; margin-top: 8px; }
  .tube-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); grid-gap: 10px; justify-content: center; margin: 10px; }
  .tube { width: 60px; height: 180px; border: 2px solid #888; border-radius: 10px; display: flex; flex-direction: column-reverse; justify-content: flex-start; align-items: center; padding: 2px; background: white; margin: auto; }
  .ball { width: 40px; height: 40px; border-radius: 50%; margin: 2px 0; cursor: pointer; }
  @media (max-width: 600px) {
    .tube { width: 50px; height: 140px; }
    .ball { width: 30px; height: 30px; }
    button { font-size: 14px; padding: 8px 12px; }
  }
</style>
</head>
<body>
<h2>Color Sort Puzzle - Level 658 (Simplified)</h2>
<p>點選一個管子，再點另一個管子移動球。必須顏色相同或空管才能移動。</p>
<div class="controls">
  <button class="btn-undo" onclick="undo()">上一步</button>
  <button class="btn-redo" onclick="redo()">下一步</button>
  <button class="btn-reset" onclick="reset()">重設關卡</button>
</div>
<div class="steps">步數: <span id="steps">0</span></div>
<div class="tube-container" id="game"></div>

<script>
const colors = {
  red: '#e74c3c', blue: '#3498db', green: '#2ecc71', yellow: '#f1c40f',
  purple: '#9b59b6', orange: '#e67e22', pink: '#ff69b4', black: '#2d3436'
};

let initialLevel = [
  [], [], // 空管
  ['blue','red','pink','purple'],
  ['pink','blue','green','purple'],
  ['red','green','black','orange'],
  ['orange','yellow','green','purple'],
  ['black','yellow','green','pink'],
  ['purple','orange','yellow','blue'],
  ['red','pink','yellow','orange'],
  ['blue','black','green','red']
];

let level = [];
let history = [];
let redoStack = [];
let steps = 0;

const gameEl = document.getElementById('game');
const stepsEl = document.getElementById('steps');

// 儲存與讀取進度
function saveProgress() {
  localStorage.setItem('colorSortLevel', JSON.stringify(level));
  localStorage.setItem('colorSortHistory', JSON.stringify(history));
  localStorage.setItem('colorSortRedo', JSON.stringify(redoStack));
  localStorage.setItem('colorSortSteps', steps);
}

function loadProgress() {
  const savedLevel = localStorage.getItem('colorSortLevel');
  if (savedLevel) {
    level = JSON.parse(savedLevel);
    history = JSON.parse(localStorage.getItem('colorSortHistory')) || [];
    redoStack = JSON.parse(localStorage.getItem('colorSortRedo')) || [];
    steps = parseInt(localStorage.getItem('colorSortSteps')) || 0;
  } else {
    level = JSON.parse(JSON.stringify(initialLevel));
    history = [];
    redoStack = [];
    steps = 0;
  }
}

function render() {
  gameEl.innerHTML = '';
  level.forEach((tube, i) => {
    const tubeEl = document.createElement('div');
    tubeEl.className = 'tube';
    tubeEl.dataset.index = i;
    tube.forEach(color => {
      const ball = document.createElement('div');
      ball.className = 'ball';
      ball.style.background = colors[color] || color;
      ball.dataset.color = color;
      tubeEl.appendChild(ball);
    });
    gameEl.appendChild(tubeEl);
  });
  stepsEl.textContent = steps;
  saveProgress();
}

let selected = null;

gameEl.addEventListener('click', e => {
  const tubeEl = e.target.closest('.tube');
  if (!tubeEl) return;
  const idx = parseInt(tubeEl.dataset.index);

  if (selected === null) {
    if (level[idx].length > 0) {
      selected = idx;
      tubeEl.style.border = '3px solid red';
    }
  } else {
    if (selected !== idx) {
      let fromTube = level[selected];
      let toTube = level[idx];
      if (fromTube.length > 0 && toTube.length < 4) {
        let movingColor = fromTube[fromTube.length - 1];
        if (toTube.length === 0 || toTube[toTube.length - 1] === movingColor) {
          history.push(JSON.parse(JSON.stringify(level)));
          redoStack = [];
          toTube.push(fromTube.pop());
          steps++;
        }
      }
    }
    document.querySelectorAll('.tube').forEach(t => t.style.border = '2px solid #888');
    selected = null;
    render();
    checkWin();
  }
});

function undo() {
  if (history.length > 0) {
    redoStack.push(JSON.parse(JSON.stringify(level)));
    level = history.pop();
    steps--;
    render();
  }
}

function redo() {
  if (redoStack.length > 0) {
    history.push(JSON.parse(JSON.stringify(level)));
    level = redoStack.pop();
    steps++;
    render();
  }
}

function reset() {
  level = JSON.parse(JSON.stringify(initialLevel));
  history = [];
  redoStack = [];
  steps = 0;
  render();
}

function checkWin() {
  let done = level.every(tube => tube.length === 0 || tube.every(c => c === tube[0]));
  if (done) alert('You Win! 總步數: ' + steps);
}

// 初始化
loadProgress();
render();
</script>
</body>
</html>